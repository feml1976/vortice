---
title: Secuencia - Registro de Muestreo de Llantas
---
sequenceDiagram
    actor Operario
    participant UI as UI React
    participant API as API Controller
    participant UseCase as RegistrarMuestreoUseCase
    participant LlantaRepo as LlantaRepository
    participant MuestreoRepo as MuestreoRepository
    participant FichaRepo as FichaTecnicaRepository
    participant AlertaSvc as AlertaService
    participant DB as PostgreSQL

    Operario->>UI: Ir a m√≥dulo de muestreo
    UI->>API: GET /api/vehiculos?operando=true
    API-->>UI: Lista de veh√≠culos operando

    Operario->>UI: Seleccionar veh√≠culo (placa)
    
    UI->>API: GET /api/llantas/activas/{placa}
    API->>LlantaRepo: findActivasByVehiculo(placa)
    LlantaRepo->>DB: SELECT l.*, f.*, m.* FROM llantas l<br/>JOIN fichatec f ON l.ficha = f.codigo<br/>LEFT JOIN muestreo m ON l.llanta = m.llanta
    DB-->>LlantaRepo: Llantas activas con √∫ltimo muestreo
    LlantaRepo-->>API: List<LlantaActivaConMuestreo>
    API-->>UI: List<LlantaMuestreoDTO>

    UI->>UI: Renderizar grilla de llantas del veh√≠culo
    Note over UI: Mostrar por cada llanta:<br/>- Posici√≥n<br/>- N√∫mero de llanta<br/>- √öltimo muestreo (fecha, prof, KM)<br/>- Profundidades iniciales

    Operario->>UI: Ingresar datos del veh√≠culo
    Note over Operario,UI: - Kilometraje actual del veh√≠culo<br/>- Fecha del muestreo

    loop Para cada llanta en el veh√≠culo
        Operario->>UI: Ingresar profundidades
        Note over Operario,UI: - PI (Profundidad Interna)<br/>- PC (Profundidad Central)<br/>- PD (Profundidad Derecha)<br/>- Presi√≥n (PSI)

        UI->>UI: Validaciones en tiempo real
        Note over UI: - Prof <= Prof_Inicial<br/>- Prof >= 0<br/>- Calcular promedio<br/>- Mostrar % desgaste<br/>- Color seg√∫n criticidad
    end

    Operario->>UI: Enviar muestreo completo

    UI->>UI: Validaciones finales
    Note over UI: - KM >= KM instalaci√≥n (todas las llantas)<br/>- Fecha >= fecha instalaci√≥n<br/>- Todas las profundidades v√°lidas

    UI->>API: POST /api/muestreos/batch
    Note over UI,API: Request Body:<br/>{<br/>  placa: "ABC123",<br/>  kilometraje: 95000,<br/>  fecha: "2026-01-20",<br/>  muestreos: [<br/>    {llantaId, PI, PC, PD, presion},<br/>    ...<br/>  ]<br/>}

    API->>UseCase: execute(comando)

    UseCase->>LlantaRepo: validarTodasLlantasPertenecenAVehiculo(placa, llantaIds)
    LlantaRepo->>DB: SELECT COUNT
    DB-->>LlantaRepo: count
    LlantaRepo-->>UseCase: boolean

    UseCase->>DB: BEGIN TRANSACTION

    loop Para cada muestreo en el batch
        
        %% Obtener llanta y ficha t√©cnica
        UseCase->>LlantaRepo: findById(llantaId)
        LlantaRepo->>DB: SELECT FROM llantas
        DB-->>LlantaRepo: Llanta
        LlantaRepo-->>UseCase: Llanta

        UseCase->>FichaRepo: findById(llanta.fichaId)
        FichaRepo->>DB: SELECT FROM fichatec
        DB-->>FichaRepo: FichaTecnica
        FichaRepo-->>UseCase: FichaTecnica

        %% Validaciones de negocio
        UseCase->>UseCase: validarKilometraje(km >= llanta.kmInstalacion)
        UseCase->>UseCase: validarProfundidades(PI,PC,PD <= profIniciales)
        UseCase->>UseCase: validarFecha(fecha >= llanta.fechaInstalacion)

        %% Calcular m√©tricas
        UseCase->>UseCase: calcularProfundidadPromedio()
        UseCase->>UseCase: calcularDesgaste()
        UseCase->>UseCase: calcularKmsRecorridos()
        UseCase->>UseCase: detectarDesgasteIrregular()

        %% Guardar muestreo actual
        UseCase->>MuestreoRepo: crear(muestreo)
        MuestreoRepo->>DB: INSERT INTO muestreo VALUES (...)
        DB-->>MuestreoRepo: Success

        %% Guardar en hist√≥rico
        UseCase->>MuestreoRepo: crearHistorico(muestreo)
        MuestreoRepo->>DB: INSERT INTO histomues VALUES (...)
        DB-->>MuestreoRepo: Success

        %% Actualizar contador de kil√≥metros
        UseCase->>DB: UPDATE kms_recorrido_llantas<br/>SET kmrl_kmsrecorrido_nb = kmrl_kmsrecorrido_nb + (km_actual - km_instalacion)
        DB-->>UseCase: Success

        %% An√°lisis de alertas
        alt Profundidad < L√≠mite Legal (1.6mm)
            UseCase->>AlertaSvc: generarAlerta(DESGASTE_CRITICO, llantaId)
            AlertaSvc->>DB: INSERT INTO alertas
            DB-->>AlertaSvc: Success
            AlertaSvc-->>UseCase: Alerta creada
        end

        alt Desgaste irregular detectado
            UseCase->>AlertaSvc: generarAlerta(DESGASTE_IRREGULAR, llantaId)
            AlertaSvc->>DB: INSERT INTO alertas
            DB-->>AlertaSvc: Success
            AlertaSvc-->>UseCase: Alerta creada
        end

        alt Presi√≥n fuera de rango (80-130 PSI)
            UseCase->>AlertaSvc: generarAlerta(PRESION_INCORRECTA, llantaId)
            AlertaSvc->>DB: INSERT INTO alertas
            DB-->>AlertaSvc: Success
            AlertaSvc-->>UseCase: Alerta creada
        end

    end

    UseCase->>DB: COMMIT TRANSACTION

    %% Calcular proyecciones de vida √∫til
    UseCase->>UseCase: calcularProyeccionVidaUtil()
    Note over UseCase: Por cada llanta:<br/>- KMs esperados restantes<br/>- D√≠as estimados restantes<br/>- Fecha estimada de reemplazo

    UseCase-->>API: Result.success(MuestreoResultDTO)
    Note over UseCase,API: Incluye:<br/>- Muestreos guardados<br/>- Alertas generadas<br/>- Proyecciones

    API-->>UI: 200 OK - MuestreoResultDTO

    UI->>UI: Procesar respuesta

    alt Hay alertas cr√≠ticas
        UI->>UI: Mostrar modal con alertas
        Note over UI: Destacar llantas que requieren<br/>atenci√≥n inmediata (rojo)
        UI-->>Operario: ‚ö†Ô∏è Alertas de llantas cr√≠ticas
    end

    UI->>UI: Actualizar vista con resultados
    UI->>UI: Mostrar resumen de muestreo
    Note over UI: - Total llantas muestreadas<br/>- Alertas generadas<br/>- Proyecciones de vida √∫til

    UI-->>Operario: ‚úì Muestreo registrado exitosamente

    %% Generar reporte
    Operario->>UI: Descargar reporte de muestreo
    UI->>API: GET /api/muestreos/reporte/{vehiculo}/{fecha}
    API-->>UI: PDF con resultados del muestreo

    UI-->>Operario: üìÑ Reporte descargado
